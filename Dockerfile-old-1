FROM webdevops/php-nginx:7.3

# Обновляем ключ подписи для репозитория Nginx
RUN wget -O - http://nginx.org/keys/nginx_signing.key | apt-key add -

# Обновляем пакеты и устанавливаем зависимости в одном шаге
RUN apt-get update -y && apt-get install -y \
    supervisor \
    cron \
    && rm -rf /var/lib/apt/lists/*

# Устанавливаем модуль JSON для PHP 7.3 (если он ещё не установлен)
RUN if ! php -m | grep -q json; then \
    apt-get install -y php7.3-json; \
    fi

# Проверяем и устанавливаем модуль calendar через PECL, если он нужен
RUN if ! php -m | grep -q calendar; then \
    apt-get install -y php-pear php7.3-dev build-essential && \
    pecl install calendar && \
    echo "extension=calendar.so" > /etc/php/7.3/mods-available/calendar.ini && \
    ln -s /etc/php/7.3/mods-available/calendar.ini /etc/php/7.3/fpm/conf.d/20-calendar.ini && \
    ln -s /etc/php/7.3/mods-available/calendar.ini /etc/php/7.3/cli/conf.d/20-calendar.ini; \
    fi

# Очищаем временные файлы
RUN apt-get clean && rm -rf /tmp/* /var/tmp/*

# Изменяем порты PHP-FPM и Nginx с 9000 на 9001
RUN sed -i 's/9000/9001/g' /opt/docker/etc/php/fpm/pool.d/application.conf
RUN sed -i 's/9000/9001/g' /opt/docker/etc/nginx/conf.d/10-php.conf

# Удаляем старый vhost.conf и создаём директории
RUN rm -f /opt/docker/etc/nginx/vhost.conf
RUN mkdir -p /usr/share/nginx/html/taxi \
    /usr/share/nginx/html/sessions \
    /usr/share/nginx/html/laravel_logs \
    /usr/share/nginx/html/cache \
    /etc/ssl/certs/nginx

# Устанавливаем права доступа (избегаем 777 там, где возможно)
RUN chmod -R 755 /usr/share/nginx/html/sessions \
    /usr/share/nginx/html/cache \
    /etc/ssl/certs/nginx
RUN chmod -R 777 /usr/share/nginx/html/laravel_logs  # Только для логов, если нужно

# Копируем файлы проекта
COPY ./app /usr/share/nginx/html/taxi/app
COPY ./bootstrap /usr/share/nginx/html/taxi/bootstrap
COPY ./config /usr/share/nginx/html/taxi/config
COPY ./database /usr/share/nginx/html/taxi/database
COPY ./docker /usr/share/nginx/html/taxi/docker
COPY ./public /usr/share/nginx/html/taxi/public
COPY ./resources /usr/share/nginx/html/taxi/resources
COPY ./routes /usr/share/nginx/html/taxi/routes
COPY ./storage /usr/share/nginx/html/taxi/storage
COPY ./tests /usr/share/nginx/html/taxi/tests
COPY ./tmp /usr/share/nginx/html/taxi/tmp
COPY ./vendor /usr/share/nginx/html/taxi/vendor
COPY ./.editorconfig /usr/share/nginx/html/taxi/
COPY ./.env /usr/share/nginx/html/taxi/
COPY ./.styleci.yml /usr/share/nginx/html/taxi/
COPY ./anceta.docx /usr/share/nginx/html/taxi/
COPY ./artisan /usr/share/nginx/html/taxi/
COPY ./composer.json /usr/share/nginx/html/taxi/
COPY ./composer.lock /usr/share/nginx/html/taxi/
COPY ./google48a0497e525302d5.html /usr/share/nginx/html/taxi/
COPY ./mariadb_repo_setup /usr/share/nginx/html/taxi/
COPY ./package.json /usr/share/nginx/html/taxi/
COPY ./package-lock.json /usr/share/nginx/html/taxi/
COPY ./php /usr/share/nginx/html/taxi/
COPY ./phpunit.xml /usr/share/nginx/html/taxi/
COPY ./questionnaire.docx /usr/share/nginx/html/taxi/
COPY ./README.md /usr/share/nginx/html/taxi/
COPY ./server.php /usr/share/nginx/html/taxi/
COPY ./webpack.mix.js /usr/share/nginx/html/taxi/

# Копируем конфигурации и службы
RUN cp /usr/share/nginx/html/taxi/docker/supervisord.conf /etc/supervisord.conf
RUN cp /usr/share/nginx/html/taxi/docker/taxi.conf /opt/docker/etc/nginx/vhost.conf
RUN cp -r /usr/share/nginx/html/taxi/docker/certs/nginx /etc/ssl/certs/nginx
RUN cp /usr/share/nginx/html/taxi/docker/laravel-worker.service /etc/systemd/system/laravel-worker.service
RUN cp /usr/share/nginx/html/taxi/docker/watch_log.service /etc/systemd/system/watch_log.service
RUN cp /usr/share/nginx/html/taxi/docker/watch_log.sh /usr/share/nginx/html/laravel_logs/watch_log.sh

# Настраиваем Cron
RUN echo "*/15 * * * * cd /usr/share/nginx/html/taxi && php artisan daily-task:run" >> /etc/cron.d/laravel-cron && \
    echo "0 22 * * * cd /usr/share/nginx/html/taxi && php artisan driver-balance-report-task:run" >> /etc/cron.d/laravel-cron && \
    echo "0 22 * * * cd /usr/share/nginx/html/taxi && php artisan logs:send" >> /etc/cron.d/laravel-cron && \
    echo "0 21 * * * cd /usr/share/nginx/html/taxi && php artisan clean-task:run" >> /etc/cron.d/laravel-cron && \
    chmod 0644 /etc/cron.d/laravel-cron && \
    crontab /etc/cron.d/laravel-cron

# Устанавливаем права доступа ко всем файлам проекта
RUN chmod -R 777 /usr/share/nginx/html/taxi/

# Экспонируем порт для HTTPS
EXPOSE 7443

# Настраиваем запуск через Supervisor (убираем ручной запуск служб)
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]
